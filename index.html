<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceMGT</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for Dashboard Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        .dark ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .hidden { display: none; }
    </style>
    <script>
        // Configuration for Tailwind CSS dark mode
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 font-sans">

    <!-- App Container -->
    <div id="app-container" class="hidden h-screen flex">
        <!-- Sidebar -->
        <aside id="sidebar" class="absolute lg:relative z-30 w-64 bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 h-full shadow-xl transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col">
            <div class="p-6 flex items-center justify-between">
                <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-teal-400">FinanceMGT</h1>
                <button id="close-sidebar-btn" class="lg:hidden text-gray-500 dark:text-gray-400">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <nav id="nav-menu" class="flex-1 px-4">
                <!-- Nav items will be dynamically inserted here -->
            </nav>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                <a href="#" class="nav-item flex items-center px-4 py-3 my-1 rounded-lg text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="settings"></i><span class="ml-4 font-medium">Settings</span>
                </a>
                <a href="#" id="logout-btn" class="nav-item flex items-center px-4 py-3 my-1 rounded-lg text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="log-out"></i><span class="ml-4 font-medium">Log Out</span>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex items-center justify-between p-4 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
                <button id="open-sidebar-btn" class="lg:hidden text-gray-600 dark:text-gray-300">
                    <i data-lucide="menu"></i>
                </button>
                <div class="flex-1"></div>
                <div class="flex items-center space-x-4">
                    <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        <i data-lucide="sun" class="block dark:hidden"></i>
                        <i data-lucide="moon" class="hidden dark:block"></i>
                    </button>
                </div>
            </header>
            <main id="main-content" class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 dark:bg-gray-900 p-4 sm:p-6 lg:p-8">
                <!-- Page content will be dynamically inserted here -->
            </main>
        </div>
    </div>

    <!-- Landing Page -->
    <div id="landing-page" class="min-h-screen flex flex-col items-center justify-center bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 p-4 transition-colors duration-500">
        <div class="absolute top-4 right-4">
            <button id="landing-theme-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                <i data-lucide="sun" class="block dark:hidden"></i>
                <i data-lucide="moon" class="hidden dark:block"></i>
            </button>
        </div>
        <div class="text-center z-10">
            <h1 class="text-5xl md:text-7xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-teal-400 mb-4">
                FinanceMGT
            </h1>
            <p class="text-lg md:text-xl text-gray-600 dark:text-gray-400 max-w-2xl mx-auto mb-8">
                Your intelligent financial co-pilot. Track income, manage budgets, and allocate funds with precision.
            </p>
            <button id="enter-dashboard-btn" class="bg-gradient-to-r from-blue-500 to-teal-400 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 ease-in-out">
                Enter Dashboard
            </button>
        </div>
        <div class="absolute inset-0 bg-[radial-gradient(circle_500px_at_50%_200px,#3b82f622,transparent)] -z-1"></div>
    </div>

    <!-- Modal Container -->
    <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4 transition-opacity">
        <!-- Modal content will be dynamically inserted here -->
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- STATE MANAGEMENT (DATA) ---
    const initialState = {
        incomeSources: [
            { id: 1, name: 'Monthly Salary', amount: 3800, type: 'Primary' },
            { id: 2, name: 'Freelance Project', amount: 650, type: 'Side Hustle' },
        ],
        budgets: [
            { id: 1, name: 'Rent', category: 'Housing', amount: 1450, dueDate: '2024-08-01', status: 'Paid' },
            { id: 2, name: 'Council Tax', category: 'Housing', amount: 180, dueDate: '2024-08-05', status: 'Paid' },
            { id: 3, name: 'Groceries', category: 'Groceries', amount: 400, dueDate: 'N/A', status: 'Ongoing' },
        ],
        subscriptions: [
            { id: 1, name: 'Netflix', amount: 13.99, billingCycle: 'Monthly', nextPayment: '2024-08-15' },
            { id: 2, name: 'Spotify', amount: 10.99, billingCycle: 'Monthly', nextPayment: '2024-08-11' },
        ],
        overtime: [
            { id: 1, date: '2024-07-20', time: '18:00 - 22:00', amount: 120, allocation: 'Vacation Fund', status: 'Completed' },
            { id: 2, date: '2024-07-28', time: '20:00 - 23:00', amount: 70, allocation: 'Vacation Fund', status: 'Not Started' },
        ],
        activePage: 'dashboard',
    };

    // --- LOCAL STORAGE FUNCTIONS ---
    function saveState() {
        localStorage.setItem('financeMgtState', JSON.stringify(state));
    }

    function loadState() {
        const savedState = localStorage.getItem('financeMgtState');
        return savedState ? JSON.parse(savedState) : null;
    }

    let state = loadState() || initialState;

    // --- UTILITY FUNCTIONS ---
    const formatCurrency = (amount) => new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(amount);
    const getIcon = (name, classes = "w-5 h-5") => `<i data-lucide="${name}" class="${classes}"></i>`;
    const categoryIcons = {
        'Groceries': 'shopping-cart', 'Utilities': 'zap', 'Transport': 'car', 'Housing': 'home',
        'Entertainment': 'film', 'Health': 'heart', 'Subscriptions': 'repeat', 'Income': 'dollar-sign',
        'Personal Care': 'heart', 'Debt': 'credit-card', 'Savings': 'trending-up', 'Other': 'book-open',
    };
    const navItems = [
        { id: 'dashboard', label: 'Dashboard', icon: 'trending-up' },
        { id: 'income', label: 'Income', icon: 'dollar-sign' },
        { id: 'budget', label: 'Budgets', icon: 'shopping-cart' },
        { id: 'subscriptions', label: 'Subscriptions', icon: 'repeat' },
        { id: 'overtime', label: 'Overtime', icon: 'clock' },
    ];
    const statusBadge = (status) => {
        const styles = {
            'Paid': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300',
            'Completed': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300',
            'Upcoming': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300',
            'Overdue': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300',
            'Ongoing': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300',
            'Not Started': 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300',
        };
        return `<span class="px-2.5 py-0.5 rounded-full text-xs font-medium ${styles[status] || ''}">${status}</span>`;
    };
    
    // --- DOM ELEMENTS ---
    const mainContent = document.getElementById('main-content');
    const modalContainer = document.getElementById('modal-container');
    const navMenu = document.getElementById('nav-menu');
    let expenseChart = null; // To hold the chart instance

    // --- MODAL MANAGEMENT ---
    function openModal(title, content) {
        modalContainer.innerHTML = `
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full transform transition-all" onclick="event.stopPropagation()">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200">${title}</h3>
                    <button class="close-modal-btn p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">${getIcon('x')}</button>
                </div>
                ${content}
            </div>`;
        modalContainer.classList.remove('hidden');
        lucide.createIcons();
    }

    function closeModal() {
        modalContainer.classList.add('hidden');
        modalContainer.innerHTML = '';
    }

    // --- RENDER FUNCTIONS ---
    function renderNav() {
        navMenu.innerHTML = navItems.map(item => `
            <a href="#" data-page="${item.id}" class="nav-item flex items-center px-4 py-3 my-1 rounded-lg transition-colors duration-200 ${state.activePage === item.id ? 'bg-blue-500 text-white shadow-md' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700'}">
                ${getIcon(item.icon)}
                <span class="ml-4 font-medium">${item.label}</span>
            </a>
        `).join('');
    }

    function renderPage() {
        const pageRenderers = {
            'dashboard': renderDashboard,
            'income': renderIncomePage,
            'budget': renderBudgetPage,
            'subscriptions': renderSubscriptionsPage,
            'overtime': renderOvertimePage,
        };
        if (pageRenderers[state.activePage]) {
            pageRenderers[state.activePage]();
        }
        lucide.createIcons();
        renderNav();
    }
    
    // --- DASHBOARD PAGE ---
    function renderDashboard() {
        const primaryIncome = state.incomeSources.reduce((sum, i) => sum + i.amount, 0);
        const overtimeIncome = state.overtime.reduce((sum, o) => sum + o.amount, 0);
        const totalIncome = primaryIncome + overtimeIncome;
        const totalBudgeted = state.budgets.reduce((sum, b) => sum + b.amount, 0);
        const totalSubscriptionCost = state.subscriptions.reduce((sum, s) => sum + s.amount, 0);
        const totalExpenses = totalBudgeted + totalSubscriptionCost;
        const balance = totalIncome - totalExpenses;

        mainContent.innerHTML = `
            <div class="space-y-6">
                <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200">Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white p-6 rounded-xl shadow-lg">
                        <div class="flex justify-between items-start"><div><p class="text-sm font-medium opacity-80">Net Balance</p><p class="text-3xl font-bold">${formatCurrency(balance)}</p></div><div class="p-3 bg-white/20 rounded-lg">${getIcon('dollar-sign', 'w-6 h-6')}</div></div>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-emerald-600 text-white p-6 rounded-xl shadow-lg">
                        <div class="flex justify-between items-start"><div><p class="text-sm font-medium opacity-80">Total Income</p><p class="text-3xl font-bold">${formatCurrency(totalIncome)}</p></div><div class="p-3 bg-white/20 rounded-lg">${getIcon('trending-up', 'w-6 h-6')}</div></div>
                    </div>
                    <div class="bg-gradient-to-br from-red-500 to-rose-600 text-white p-6 rounded-xl shadow-lg">
                        <div class="flex justify-between items-start"><div><p class="text-sm font-medium opacity-80">Total Expenses</p><p class="text-3xl font-bold">${formatCurrency(totalExpenses)}</p></div><div class="p-3 bg-white/20 rounded-lg">${getIcon('trending-down', 'w-6 h-6')}</div></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                        <h3 class="font-semibold text-lg text-gray-800 dark:text-gray-200 mb-4">Expense Composition</h3>
                        <canvas id="expenseChart"></canvas>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                            <h3 class="font-semibold text-lg text-gray-800 dark:text-gray-200 mb-4">Total Overtime Earned</h3>
                            <p class="text-3xl font-bold text-gray-800 dark:text-gray-200">${formatCurrency(overtimeIncome)}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">from ${state.overtime.length} shifts</p>
                            <button data-page="overtime" class="nav-item w-full flex items-center justify-center bg-blue-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-600 transition-colors">Manage Overtime ${getIcon('arrow-right', 'w-4 h-4 ml-2')}</button>
                        </div>
                    </div>
                </div>
            </div>`;
        
        if (expenseChart) expenseChart.destroy();
        const ctx = document.getElementById('expenseChart').getContext('2d');
        expenseChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Budget Items', 'Subscriptions'],
                datasets: [{
                    data: [totalBudgeted, totalSubscriptionCost],
                    backgroundColor: ['#4f46e5', '#818cf8'],
                    borderColor: document.documentElement.classList.contains('dark') ? '#1f2937' : '#fff',
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top', labels: { color: document.documentElement.classList.contains('dark') ? '#d1d5db' : '#374151' } },
                }
            }
        });
    }

    // --- GENERIC CRUD PAGE RENDERER ---
    function createCrudPage({ pageTitle, itemType, data, tableHeaders, rowRenderer, totalLabel, totalValue }) {
        mainContent.innerHTML = `
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200">${pageTitle}</h2>
                    <button data-action="add" class="flex items-center bg-blue-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-600 transition-colors">${getIcon('plus-circle', 'w-5 h-5 mr-2')} Add ${itemType}</button>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-md">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead><tr class="border-b border-gray-200 dark:border-gray-700">${tableHeaders.map(h => `<th class="p-3 text-sm font-semibold text-gray-500 dark:text-gray-400 ${h.align === 'right' ? 'text-right' : ''}">${h.label}</th>`).join('')}</tr></thead>
                            <tbody>${data.map(rowRenderer).join('')}</tbody>
                            <tfoot class="border-t-2 border-gray-200 dark:border-gray-700">
                                <tr>
                                    <td colspan="${tableHeaders.length - 1}" class="p-3 font-bold text-gray-800 dark:text-gray-200">${totalLabel}</td>
                                    <td class="p-3 text-right font-bold text-lg ${pageTitle.includes('Income') || pageTitle.includes('Overtime') ? 'text-green-500' : 'text-gray-800 dark:text-gray-200'}">${formatCurrency(totalValue)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>`;
    }
    
    // --- PAGE IMPLEMENTATIONS ---
    function renderIncomePage() {
        createCrudPage({
            pageTitle: 'Income Sources', itemType: 'Income', data: state.incomeSources,
            tableHeaders: [
                { label: 'Source' }, { label: 'Type' }, { label: 'Amount', align: 'right' }, { label: 'Actions', align: 'right' }
            ],
            rowRenderer: source => `
                <tr class="border-b border-gray-200 dark:border-gray-700 last:border-0">
                    <td class="p-3 font-medium text-gray-800 dark:text-gray-200">${source.name}</td>
                    <td class="p-3"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">${source.type}</span></td>
                    <td class="p-3 text-right font-semibold text-green-500">${formatCurrency(source.amount)}</td>
                    <td class="p-3 text-right"><div class="flex justify-end items-center space-x-2">
                        <button data-action="edit" data-id="${source.id}" class="p-2 text-gray-500 hover:text-blue-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">${getIcon('pencil', 'w-4 h-4')}</button>
                        <button data-action="delete" data-id="${source.id}" class="p-2 text-gray-500 hover:text-red-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">${getIcon('trash-2', 'w-4 h-4')}</button>
                    </div></td>
                </tr>`,
            totalLabel: 'Total Monthly Income', totalValue: state.incomeSources.reduce((sum, i) => sum + i.amount, 0)
        });
    }

    function renderBudgetPage() {
        createCrudPage({
            pageTitle: 'Budget Items', itemType: 'Budget', data: state.budgets,
            tableHeaders: [
                { label: 'Item' }, { label: 'Category' }, { label: 'Due Date' }, { label: 'Status' }, { label: 'Amount', align: 'right' }, { label: 'Actions', align: 'right' }
            ],
            rowRenderer: item => `
                <tr class="border-b border-gray-200 dark:border-gray-700 last:border-0">
                    <td class="p-3 font-medium text-gray-800 dark:text-gray-200">${item.name}</td>
                    <td class="p-3 text-gray-600 dark:text-gray-300"><span class="inline-flex items-center text-xs font-medium">${getIcon(categoryIcons[item.category] || 'book-open', 'w-4 h-4 mr-2')} ${item.category}</span></td>
                    <td class="p-3 text-sm text-gray-600 dark:text-gray-300">${item.dueDate}</td>
                    <td class="p-3">${statusBadge(item.status)}</td>
                    <td class="p-3 text-right font-semibold text-gray-700 dark:text-gray-200">${formatCurrency(item.amount)}</td>
                    <td class="p-3 text-right"><div class="flex justify-end items-center space-x-2">
                        <button data-action="edit" data-id="${item.id}" class="p-2 text-gray-500 hover:text-blue-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">${getIcon('pencil', 'w-4 h-4')}</button>
                        <button data-action="delete" data-id="${item.id}" class="p-2 text-gray-500 hover:text-red-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">${getIcon('trash-2', 'w-4 h-4')}</button>
                    </div></td>
                </tr>`,
            totalLabel: 'Total Budgeted', totalValue: state.budgets.reduce((sum, i) => sum + i.amount, 0)
        });
    }
    
    function renderSubscriptionsPage() {
        createCrudPage({
            pageTitle: 'Subscriptions', itemType: 'Subscription', data: state.subscriptions,
            tableHeaders: [
                { label: 'Name' }, { label: 'Billing Cycle' }, { label: 'Next Payment' }, { label: 'Amount', align: 'right' }, { label: 'Actions', align: 'right' }
            ],
            rowRenderer: sub => `
                <tr class="border-b border-gray-200 dark:border-gray-700 last:border-0">
                    <td class="p-3 font-medium text-gray-800 dark:text-gray-200">${sub.name}</td>
                    <td class="p-3 text-sm text-gray-600 dark:text-gray-300">${sub.billingCycle}</td>
                    <td class="p-3 text-sm text-gray-600 dark:text-gray-300">${sub.nextPayment}</td>
                    <td class="p-3 text-right font-semibold text-gray-700 dark:text-gray-200">${formatCurrency(sub.amount)}</td>
                    <td class="p-3 text-right"><div class="flex justify-end items-center space-x-2">
                        <button data-action="edit" data-id="${sub.id}" class="p-2 text-gray-500 hover:text-blue-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">${getIcon('pencil', 'w-4 h-4')}</button>
                        <button data-action="delete" data-id="${sub.id}" class="p-2 text-gray-500 hover:text-red-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">${getIcon('trash-2', 'w-4 h-4')}</button>
                    </div></td>
                </tr>`,
            totalLabel: 'Total Monthly Cost', totalValue: state.subscriptions.reduce((sum, i) => sum + i.amount, 0)
        });
    }

    function renderOvertimePage() {
        createCrudPage({
            pageTitle: 'Overtime Log', itemType: 'Overtime', data: state.overtime,
            tableHeaders: [
                { label: 'Date' }, { label: 'Time' }, { label: 'Allocation' }, { label: 'Status' }, { label: 'Amount', align: 'right' }, { label: 'Actions', align: 'right' }
            ],
            rowRenderer: item => `
                <tr class="border-b border-gray-200 dark:border-gray-700 last:border-0">
                    <td class="p-3 font-medium text-gray-800 dark:text-gray-200">${item.date}</td>
                    <td class="p-3 text-sm text-gray-600 dark:text-gray-300">${item.time}</td>
                    <td class="p-3 text-sm text-gray-600 dark:text-gray-300">${item.allocation}</td>
                    <td class="p-3">${statusBadge(item.status)}</td>
                    <td class="p-3 text-right font-semibold text-green-500">${formatCurrency(item.amount)}</td>
                    <td class="p-3 text-right"><div class="flex justify-end items-center space-x-2">
                        <button data-action="edit" data-id="${item.id}" class="p-2 text-gray-500 hover:text-blue-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">${getIcon('pencil', 'w-4 h-4')}</button>
                        <button data-action="delete" data-id="${item.id}" class="p-2 text-gray-500 hover:text-red-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">${getIcon('trash-2', 'w-4 h-4')}</button>
                    </div></td>
                </tr>`,
            totalLabel: 'Total Overtime Earned', totalValue: state.overtime.reduce((sum, i) => sum + i.amount, 0)
        });
    }

    // --- EVENT LISTENERS ---
    
    // Theme Toggling
    function handleThemeToggle() {
        document.documentElement.classList.toggle('dark');
        if (state.activePage === 'dashboard') renderDashboard(); // Re-render chart with new theme colors
    }
    document.getElementById('theme-toggle').addEventListener('click', handleThemeToggle);
    document.getElementById('landing-theme-toggle').addEventListener('click', handleThemeToggle);

    // Page Navigation
    document.body.addEventListener('click', (e) => {
        const navItem = e.target.closest('.nav-item');
        if (navItem && navItem.dataset.page) {
            e.preventDefault();
            state.activePage = navItem.dataset.page;
            saveState();
            renderPage();
            if (window.innerWidth < 1024) {
                document.getElementById('sidebar').classList.add('-translate-x-full');
            }
        }
    });
    
    // Sidebar Toggle
    document.getElementById('open-sidebar-btn').addEventListener('click', () => document.getElementById('sidebar').classList.remove('-translate-x-full'));
    document.getElementById('close-sidebar-btn').addEventListener('click', () => document.getElementById('sidebar').classList.add('-translate-x-full'));

    // App Entry / Exit
    document.getElementById('enter-dashboard-btn').addEventListener('click', () => {
        document.getElementById('landing-page').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
        document.getElementById('app-container').classList.add('flex');
        saveState(); // Save initial state on first entry
        renderPage();
    });
    document.getElementById('logout-btn').addEventListener('click', (e) => {
        e.preventDefault();
        localStorage.removeItem('financeMgtState');
        window.location.reload();
    });
    
    // Modal Close
    modalContainer.addEventListener('click', e => {
        if (e.target === modalContainer || e.target.closest('.close-modal-btn')) {
            closeModal();
        }
    });

    // --- MAIN EVENT DELEGATION FOR CRUD ---
    mainContent.addEventListener('click', e => {
        const button = e.target.closest('button[data-action]');
        if (!button) return;

        const action = button.dataset.action;
        const id = button.dataset.id ? parseInt(button.dataset.id, 10) : null;
        
        const pageConfig = {
            income: { title: 'Income Source', stateKey: 'incomeSources', form: getIncomeForm },
            budget: { title: 'Budget Item', stateKey: 'budgets', form: getBudgetForm },
            subscriptions: { title: 'Subscription', stateKey: 'subscriptions', form: getSubscriptionForm },
            overtime: { title: 'Overtime Entry', stateKey: 'overtime', form: getOvertimeForm },
        }[state.activePage];

        if (!pageConfig) return;

        if (action === 'add') {
            openModal(`Add New ${pageConfig.title}`, pageConfig.form());
        } else if (action === 'edit') {
            const item = state[pageConfig.stateKey].find(i => i.id === id);
            openModal(`Edit ${pageConfig.title}`, pageConfig.form(item));
        } else if (action === 'delete') {
            const item = state[pageConfig.stateKey].find(i => i.id === id);
            openModal(`Confirm Deletion`, `
                <div class="p-6">
                    <p class="text-gray-700 dark:text-gray-300">Are you sure you want to delete "${item.name || item.allocation}"? This action cannot be undone.</p>
                </div>
                <div class="p-4 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-2 rounded-b-xl">
                    <button class="close-modal-btn px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
                    <button data-action="confirm-delete" data-id="${id}" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Delete</button>
                </div>`);
        }
    });

    modalContainer.addEventListener('click', e => {
        const button = e.target.closest('button[data-action="confirm-delete"]');
        if (!button) return;
        const id = parseInt(button.dataset.id, 10);
        const stateKey = {
            income: 'incomeSources', budget: 'budgets', subscriptions: 'subscriptions', overtime: 'overtime'
        }[state.activePage];
        
        state[stateKey] = state[stateKey].filter(item => item.id !== id);
        saveState();
        closeModal();
        renderPage();
    });

    modalContainer.addEventListener('submit', e => {
        e.preventDefault();
        const form = e.target;
        const id = form.dataset.id ? parseInt(form.dataset.id, 10) : null;
        const stateKey = {
            income: 'incomeSources', budget: 'budgets', subscriptions: 'subscriptions', overtime: 'overtime'
        }[state.activePage];

        const formData = new FormData(form);
        const newItem = { id: id || Date.now() };
        for (let [key, value] of formData.entries()) {
            newItem[key] = isNaN(value) || key === 'time' || key === 'date' || value === '' ? value : parseFloat(value);
        }

        if (id) { // Editing
            state[stateKey] = state[stateKey].map(item => item.id === id ? newItem : item);
        } else { // Adding
            state[stateKey].push(newItem);
        }
        saveState();
        closeModal();
        renderPage();
    });

    // --- FORM RENDERERS ---
    const formInputClasses = "mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md dark:text-gray-200";
    
    function getIncomeForm(item = {}) {
        return `
            <form data-id="${item.id || ''}">
                <div class="p-6 space-y-4">
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Source Name</label><input type="text" name="name" value="${item.name || ''}" class="${formInputClasses}" required></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Amount (£)</label><input type="number" step="0.01" name="amount" value="${item.amount || ''}" class="${formInputClasses}" required></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Type</label><select name="type" class="${formInputClasses}"><option ${item.type === 'Primary' ? 'selected' : ''}>Primary</option><option ${item.type === 'Side Hustle' ? 'selected' : ''}>Side Hustle</option><option ${item.type === 'Other' ? 'selected' : ''}>Other</option></select></div>
                </div>
                <div class="p-4 bg-gray-50 dark:bg-gray-800/50 border-t flex justify-end"><button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Save</button></div>
            </form>`;
    }
    
    function getBudgetForm(item = {}) {
        const categories = Object.keys(categoryIcons).filter(c => c !== 'Income');
        return `
            <form data-id="${item.id || ''}">
                <div class="p-6 space-y-4">
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Item Name</label><input type="text" name="name" value="${item.name || ''}" class="${formInputClasses}" required></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Amount (£)</label><input type="number" step="0.01" name="amount" value="${item.amount || ''}" class="${formInputClasses}" required></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Category</label><select name="category" class="${formInputClasses}">${categories.map(c => `<option ${item.category === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Due Date</label><input type="date" name="dueDate" value="${item.dueDate || ''}" class="${formInputClasses}"></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Status</label><select name="status" class="${formInputClasses}"><option ${item.status === 'Upcoming' ? 'selected' : ''}>Upcoming</option><option ${item.status === 'Paid' ? 'selected' : ''}>Paid</option><option ${item.status === 'Overdue' ? 'selected' : ''}>Overdue</option><option ${item.status === 'Ongoing' ? 'selected' : ''}>Ongoing</option></select></div>
                </div>
                <div class="p-4 bg-gray-50 dark:bg-gray-800/50 border-t flex justify-end"><button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Save</button></div>
            </form>`;
    }
    
    function getSubscriptionForm(item = {}) {
        return `
            <form data-id="${item.id || ''}">
                <div class="p-6 space-y-4">
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Name</label><input type="text" name="name" value="${item.name || ''}" class="${formInputClasses}" required></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Amount (£)</label><input type="number" step="0.01" name="amount" value="${item.amount || ''}" class="${formInputClasses}" required></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Billing Cycle</label><select name="billingCycle" class="${formInputClasses}"><option ${item.billingCycle === 'Monthly' ? 'selected' : ''}>Monthly</option><option ${item.billingCycle === 'Annually' ? 'selected' : ''}>Annually</option></select></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Next Payment</label><input type="date" name="nextPayment" value="${item.nextPayment || ''}" class="${formInputClasses}"></div>
                </div>
                <div class="p-4 bg-gray-50 dark:bg-gray-800/50 border-t flex justify-end"><button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Save</button></div>
            </form>`;
    }
    
    function getOvertimeForm(item = {}) {
        return `
            <form data-id="${item.id || ''}">
                <div class="p-6 space-y-4">
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Date</label><input type="date" name="date" value="${item.date || ''}" class="${formInputClasses}" required></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Time</label><input type="text" name="time" value="${item.time || ''}" placeholder="e.g., 18:00 - 22:00" class="${formInputClasses}" required></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Amount (£)</label><input type="number" step="0.01" name="amount" value="${item.amount || ''}" class="${formInputClasses}" required></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Allocation</label><input type="text" name="allocation" value="${item.allocation || ''}" class="${formInputClasses}" required></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Status</label><select name="status" class="${formInputClasses}"><option ${item.status === 'Not Started' ? 'selected' : ''}>Not Started</option><option ${item.status === 'Completed' ? 'selected' : ''}>Completed</option></select></div>
                </div>
                <div class="p-4 bg-gray-50 dark:bg-gray-800/50 border-t flex justify-end"><button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Save</button></div>
            </form>`;
    }

    // --- INITIAL APP LOAD ---
    function init() {
        if (loadState()) {
            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('app-container').classList.add('flex');
            renderPage();
        } else {
            document.getElementById('landing-page').classList.remove('hidden');
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('flex');
            lucide.createIcons();
        }
    }

    init();
});
</script>

</body>
</html>
