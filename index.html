<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creative Overtime Allocator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #E5E7EB;
        }
        #app-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
        }
        #app-container {
            position: relative;
            z-index: 1;
        }
        .glass-card {
            background: rgba(31, 41, 55, 0.6); /* Gray-800 with opacity */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -31px;
            top: 0;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #3B82F6; /* Blue-500 */
            border: 4px solid #1F2937;
            box-shadow: 0 0 10px #3B82F6;
        }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { 
            border: 1px solid transparent; 
            border-radius: 0.375rem; 
            min-height: 80px; 
            padding: 8px; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between;
            transition: background-color 0.2s;
        }
        .calendar-day:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .calendar-day.other-month { color: #4B5563; }
        .calendar-day .day-number { font-weight: 600; }
        .calendar-day .day-amount { font-size: 0.9rem; font-weight: 700; color: #6EE7B7; }
        .calendar-day.today { border-color: #6EE7B7; }
    </style>
</head>
<body class="text-gray-200">
    <canvas id="app-bg"></canvas>
    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-6xl">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-white">Overtime Allocator</h1>
            <p class="text-lg text-gray-400 mt-2">Visualize where your hard work goes.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- Left Column: Calendar & Form -->
            <div class="lg:col-span-2 flex flex-col gap-8">
                <div class="glass-card p-6">
                    <div class="flex justify-between items-center mb-4"><button id="prev-month" class="px-3 py-1 bg-white/10 rounded-md hover:bg-white/20">&lt;</button><h2 id="month-year" class="text-2xl font-bold"></h2><button id="next-month" class="px-3 py-1 bg-white/10 rounded-md hover:bg-white/20">&gt;</button></div>
                    <div class="calendar-grid text-center font-bold mb-2 text-gray-400"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
                    <div id="calendar-body" class="calendar-grid"></div>
                </div>
                <div class="glass-card p-6">
                    <div class="flex justify-between items-center mb-4">
                         <h2 class="text-2xl font-bold">Add Entry</h2>
                         <button id="manage-categories-btn" title="Manage Categories" class="p-2 rounded-full hover:bg-white/10">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        </button>
                    </div>
                    <form id="allocation-form">
                        <div class="mb-4"><label for="amount" class="block text-sm font-medium text-gray-400">Amount (£)</label><input type="number" id="amount" step="0.01" class="mt-1 block w-full bg-gray-900/50 border-gray-600 rounded-md shadow-sm" required></div>
                        <div class="mb-4"><label for="source" class="block text-sm font-medium text-gray-400">Source</label><select id="source" class="mt-1 block w-full bg-gray-900/50 border-gray-600 rounded-md shadow-sm" required></select></div>
                        <div class="mb-4"><label for="purpose" class="block text-sm font-medium text-gray-400">Purpose</label><select id="purpose" class="mt-1 block w-full bg-gray-900/50 border-gray-600 rounded-md shadow-sm" required></select></div>
                        <div class="mb-4"><label for="date" class="block text-sm font-medium text-gray-400">Date</label><input type="date" id="date" class="mt-1 block w-full bg-gray-900/50 border-gray-600 rounded-md shadow-sm" required style="color-scheme: dark;"></div>
                        <button type="submit" class="w-full py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">Add to Timeline</button>
                    </form>
                </div>
            </div>

            <!-- Right Column: Timeline -->
            <div class="lg:col-span-3">
                <div class="glass-card p-6 h-full">
                    <h2 class="text-2xl font-bold mb-6">Allocation Timeline for <span id="allocated-month-name"></span></h2>
                    <div id="timeline-container" class="relative border-l-2 border-gray-600 ml-5 pl-8 space-y-8 h-[calc(100%-4rem)] overflow-y-auto">
                        <!-- Timeline items will be injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="management-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-[1001]">
        <div class="glass-card p-8 w-full max-w-4xl"><h3 class="text-2xl font-bold mb-6 text-gray-200">Manage Categories</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div id="sources-management-container"></div><div id="purposes-management-container"></div></div><div class="flex justify-end gap-4 mt-6"><button type="button" id="close-management-modal" class="px-4 py-2 bg-gray-600 rounded-md hover:bg-gray-500">Done</button></div></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, deleteDoc, onSnapshot, setDoc, writeBatch, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        document.addEventListener('DOMContentLoaded', () => {
            const rawConfig = typeof __firebase_config !== 'undefined' && __firebase_config ? __firebase_config : '{}';
            const firebaseConfig = JSON.parse(rawConfig);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-allocator-app';
            
            let app, db, auth, userId;
            try { app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); } catch (e) { console.error("Firebase initialization failed:", e); }

            let allAllocatedFunds = [], allSources = [], allPurposes = [];
            const defaultSources = ['Overtime', 'Salary'];
            const defaultPurposes = ['Rent', 'Groceries', 'Savings', 'Investment'];
            let dailyTotals = {}; let currentDate = new Date();

            const allocationForm = document.getElementById('allocation-form');
            const sourceDropdown = document.getElementById('source');
            const purposeDropdown = document.getElementById('purpose');
            const timelineContainer = document.getElementById('timeline-container');
            const manageCategoriesBtn = document.getElementById('manage-categories-btn');
            const managementModal = document.getElementById('management-modal');
            const sourcesManagementContainer = document.getElementById('sources-management-container');
            const purposesManagementContainer = document.getElementById('purposes-management-container');
            const closeManagementModalBtn = document.getElementById('close-management-modal');
            const calendarBody = document.getElementById('calendar-body');
            const monthYearEl = document.getElementById('month-year');
            const allocatedMonthNameEl = document.getElementById('allocated-month-name');

            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    listenForAllocations();
                    listenForSources();
                    listenForPurposes();
                } else {
                    signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
                }
            });

            function listenForAllocations() {
                if (!userId) return;
                const q = query(collection(db, `artifacts/${appId}/users/${userId}/allocations`), orderBy("date", "desc"));
                onSnapshot(q, (snapshot) => {
                    allAllocatedFunds = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateUI();
                });
            }
            
            function updateUI() {
                renderCalendar();
                renderTimeline();
            }

            function renderTimeline() {
                timelineContainer.innerHTML = '';
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                const monthString = String(month).padStart(2, '0');
                const filteredFunds = allAllocatedFunds.filter(fund => fund.date.startsWith(`${year}-${monthString}`));

                if (filteredFunds.length === 0) {
                    timelineContainer.innerHTML = '<p class="text-gray-400">No allocations for this month.</p>';
                    return;
                }
                filteredFunds.forEach(fund => {
                    const item = document.createElement('div');
                    item.className = 'timeline-item relative';
                    item.innerHTML = `
                        <div class="p-4 bg-gray-800/50 rounded-lg shadow">
                            <p class="text-sm text-gray-400">${new Date(fund.date + 'T00:00:00').toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                            <h4 class="font-bold text-lg text-blue-400">£${parseFloat(fund.amount).toFixed(2)}</h4>
                            <p class="text-gray-300">From <span class="font-semibold text-white">${fund.source}</span> for <span class="font-semibold text-white">${fund.purpose}</span></p>
                        </div>
                    `;
                    timelineContainer.appendChild(item);
                });
            }

            function renderCalendar() {
                calendarBody.innerHTML = '';
                const year = currentDate.getFullYear(), month = currentDate.getMonth();
                const monthName = currentDate.toLocaleString('default', { month: 'long' });
                
                monthYearEl.textContent = `${monthName} ${year}`;
                allocatedMonthNameEl.textContent = monthName;

                dailyTotals = {};
                allAllocatedFunds.forEach(fund => {
                    const date = new Date(fund.date + 'T00:00:00');
                    if (date.getFullYear() === year && date.getMonth() === month) {
                        const day = date.getDate();
                        dailyTotals[day] = (dailyTotals[day] || 0) + parseFloat(fund.amount);
                    }
                });

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let i = 0; i < firstDayOfMonth; i++) calendarBody.insertAdjacentHTML('beforeend', '<div class="calendar-day other-month"></div>');
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'calendar-day';
                    const today = new Date();
                    if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) dayCell.classList.add('today');
                    const total = dailyTotals[day] || 0;
                    dayCell.innerHTML = `<span class="day-number">${day}</span>${total > 0 ? `<span class="day-amount">£${total.toFixed(2)}</span>` : ''}`;
                    calendarBody.appendChild(dayCell);
                }
            }
            
            allocationForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!userId) return;
                const newAllocation = {
                    amount: document.getElementById('amount').value,
                    source: sourceDropdown.value,
                    purpose: purposeDropdown.value,
                    date: document.getElementById('date').value
                };
                try {
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/allocations`), newAllocation);
                    allocationForm.reset();
                    document.getElementById('date').valueAsDate = new Date();
                } catch (error) { console.error("Error adding document: ", error); }
            });

            // --- Category Management ---
            manageCategoriesBtn.addEventListener('click', () => {
                populateCategoryManagementList('source');
                populateCategoryManagementList('purpose');
                managementModal.classList.remove('hidden');
            });
            closeManagementModalBtn.addEventListener('click', () => managementModal.classList.add('hidden'));

            function populateCategoryManagementList(type) {
                const container = type === 'source' ? sourcesManagementContainer : purposesManagementContainer;
                const list = type === 'source' ? allSources : allPurposes;
                const defaults = type === 'source' ? defaultSources : defaultPurposes;
                
                container.innerHTML = `<h4 class="text-lg font-semibold mb-2 text-gray-200">${type.charAt(0).toUpperCase() + type.slice(1)}s</h4><div class="space-y-2 max-h-64 overflow-y-auto border border-gray-600 p-2 rounded"></div><div class="mt-2 flex gap-2"><input type="text" placeholder="Add new..." class="new-category-input w-full p-2 bg-gray-900 border border-gray-600 rounded"><button class="add-category-btn px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 shrink-0">Add</button></div>`;
                const listContainer = container.querySelector('.space-y-2');

                list.forEach(item => {
                    const isDefault = defaults.includes(item);
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex items-center justify-between p-2 border border-gray-700 rounded bg-gray-800';
                    itemDiv.innerHTML = `
                        <span class="item-name flex-grow text-gray-300">${item}</span>
                        <div class="item-actions flex-shrink-0">
                            ${isDefault ? '<span class="text-xs text-gray-500 mr-2">Default</span>' : `
                            <button class="edit-btn p-1 text-blue-500 hover:text-blue-400" title="Edit ${item}">Edit</button>
                            <button class="delete-btn p-1 text-red-500 hover:text-red-400" title="Delete ${item}">Delete</button>`}
                        </div>
                    `;
                    listContainer.appendChild(itemDiv);

                    if (!isDefault) {
                        itemDiv.querySelector('.edit-btn').addEventListener('click', () => {
                            const newName = prompt(`Edit category name for "${item}":`, item);
                            if (newName) editCategory(item, newName.trim(), type);
                        });
                        itemDiv.querySelector('.delete-btn').addEventListener('click', () => deleteCategory(item, type));
                    }
                });
                
                container.querySelector('.add-category-btn').addEventListener('click', () => {
                    const input = container.querySelector('.new-category-input');
                    addCategory(input.value, type);
                    input.value = '';
                });
            }
            
            async function addCategory(name, type) {
                const newName = name.trim();
                const fullList = type === 'source' ? allSources : allPurposes;
                const defaults = type === 'source' ? defaultSources : defaultPurposes;
                if (!newName || fullList.find(item => item.toLowerCase() === newName.toLowerCase())) return;
                
                const customList = fullList.filter(item => !defaults.includes(item));
                customList.push(newName);
                
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/${type}s/custom`);
                try { await setDoc(docRef, { names: customList }); } catch (e) { console.error("Error adding category:", e); }
            }

            async function deleteCategory(name, type) {
                const allocationsRef = collection(db, `artifacts/${appId}/users/${userId}/allocations`);
                const q = query(allocationsRef, where(type, "==", name));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    alert(`Cannot delete "${name}" because it is currently used by ${querySnapshot.size} allocation(s).`);
                    return;
                }

                if (!confirm(`Are you sure you want to delete "${name}"?`)) return;
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/${type}s/custom`);
                const defaults = type === 'source' ? defaultSources : defaultPurposes;
                const currentList = (type === 'source' ? allSources : allPurposes).filter(item => !defaults.includes(item));
                const newList = currentList.filter(item => item !== name);
                try { await setDoc(docRef, { names: newList }); } catch (e) { console.error("Error deleting category:", e); }
            }

            async function editCategory(oldName, newName, type) {
                if (!newName || newName === oldName) return;
                const currentFullList = type === 'source' ? allSources : allPurposes;
                if (currentFullList.find(item => item.toLowerCase() === newName.toLowerCase())) { return alert('This category name already exists.'); }

                const docRef = doc(db, `artifacts/${appId}/users/${userId}/${type}s/custom`);
                const defaults = type === 'source' ? defaultSources : defaultPurposes;
                const currentCustomList = (type === 'source' ? allSources : allPurposes).filter(i => !defaults.includes(i));
                const newList = currentCustomList.map(item => item === oldName ? newName : item);

                const batch = writeBatch(db);
                batch.set(docRef, { names: newList });

                const allocationsRef = collection(db, `artifacts/${appId}/users/${userId}/allocations`);
                const q = query(allocationsRef, where(type, "==", oldName));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach(doc => { const updateData = {}; updateData[type] = newName; batch.update(doc.ref, updateData); });
                try { await batch.commit(); } catch (e) { console.error("Error updating category:", e); }
            }

            function listenForSources() {
                if (!userId) return;
                const sourcesDocRef = doc(db, `artifacts/${appId}/users/${userId}/sources/custom`);
                onSnapshot(sourcesDocRef, (docSnap) => { const customSources = docSnap.exists() ? docSnap.data().names || [] : []; allSources = [...new Set([...defaultSources, ...customSources])]; populateSourceDropdown(); refreshManagementModal(); });
            }
            function listenForPurposes() {
                if (!userId) return;
                const purposesDocRef = doc(db, `artifacts/${appId}/users/${userId}/purposes/custom`);
                onSnapshot(purposesDocRef, (docSnap) => { const customPurposes = docSnap.exists() ? docSnap.data().names || [] : []; allPurposes = [...new Set([...defaultPurposes, ...customPurposes])]; populatePurposeDropdown(); refreshManagementModal(); });
            }
            function populateSourceDropdown() {
                const selectedValue = sourceDropdown.value; sourceDropdown.innerHTML = '';
                allSources.forEach(source => { const option = document.createElement('option'); option.value = source; option.textContent = source; sourceDropdown.appendChild(option); });
                if (allSources.includes(selectedValue)) sourceDropdown.value = selectedValue;
            }
            function populatePurposeDropdown() {
                const selectedValue = purposeDropdown.value; purposeDropdown.innerHTML = '';
                allPurposes.forEach(purpose => { const option = document.createElement('option'); option.value = purpose; option.textContent = purpose; purposeDropdown.appendChild(option); });
                if (allPurposes.includes(selectedValue)) purposeDropdown.value = selectedValue;
            }
            function refreshManagementModal() {
                if (!managementModal.classList.contains('hidden')) {
                    populateCategoryManagementList('source');
                    populateCategoryManagementList('purpose');
                }
            }

            document.getElementById('date').valueAsDate = new Date();
            
            document.getElementById('prev-month').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); updateUI(); });
            document.getElementById('next-month').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); updateUI(); });
        });
    </script>

</body>
</html>
