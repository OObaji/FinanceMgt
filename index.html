<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceMGT</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for Dashboard Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        .dark ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .hidden { display: none; }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
    </style>
    <script>
        // Configuration for Tailwind CSS dark mode
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 font-sans">

    <!-- App Container -->
    <div id="app-container" class="hidden h-screen flex">
        <!-- Sidebar -->
        <aside id="sidebar" class="absolute lg:relative z-30 w-64 bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 h-full shadow-xl transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col">
            <div class="p-6 flex items-center justify-between">
                <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-teal-400">FinanceMGT</h1>
                <button id="close-sidebar-btn" class="lg:hidden text-gray-500 dark:text-gray-400">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <nav id="nav-menu" class="flex-1 px-4">
                <!-- Nav items will be dynamically inserted here -->
            </nav>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                <a href="#" class="nav-item flex items-center px-4 py-3 my-1 rounded-lg text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="settings"></i><span class="ml-4 font-medium">Settings</span>
                </a>
                <a href="#" id="logout-btn" class="nav-item flex items-center px-4 py-3 my-1 rounded-lg text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="log-out"></i><span class="ml-4 font-medium">Log Out</span>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex items-center justify-between p-4 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
                <button id="open-sidebar-btn" class="lg:hidden text-gray-600 dark:text-gray-300">
                    <i data-lucide="menu"></i>
                </button>
                <div class="flex-1"></div>
                <div class="flex items-center space-x-4">
                    <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        <i data-lucide="sun" class="block dark:hidden"></i>
                        <i data-lucide="moon" class="hidden dark:block"></i>
                    </button>
                </div>
            </header>
            <main id="main-content" class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 dark:bg-gray-900 p-4 sm:p-6 lg:p-8">
                <!-- Page content will be dynamically inserted here -->
            </main>
        </div>
    </div>

    <!-- Landing Page -->
    <div id="landing-page" class="min-h-screen flex flex-col items-center justify-center bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 p-4 transition-colors duration-500">
        <div class="absolute top-4 right-4">
            <button id="landing-theme-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                <i data-lucide="sun" class="block dark:hidden"></i>
                <i data-lucide="moon" class="hidden dark:block"></i>
            </button>
        </div>
        <div class="text-center z-10">
            <h1 class="text-5xl md:text-7xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-teal-400 mb-4">
                FinanceMGT
            </h1>
            <p class="text-lg md:text-xl text-gray-600 dark:text-gray-400 max-w-2xl mx-auto mb-8">
                Your intelligent financial co-pilot. Track income, manage budgets, and allocate funds with precision.
            </p>
            <button id="enter-dashboard-btn" class="bg-gradient-to-r from-blue-500 to-teal-400 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 ease-in-out">
                Enter Dashboard
            </button>
        </div>
        <div class="absolute inset-0 bg-[radial-gradient(circle_500px_at_50%_200px,#3b82f622,transparent)] -z-1"></div>
    </div>

    <!-- Modal Container -->
    <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4 transition-opacity">
        <!-- Modal content will be dynamically inserted here -->
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- STATE MANAGEMENT (DATA) ---
    const currentYear = new Date().getFullYear();
    const blankYearData = () => ({
        'January': [], 'February': [], 'March': [], 'April': [], 'May': [], 'June': [], 
        'July': [], 'August': [], 'September': [], 'October': [], 'November': [], 'December': []
    });

    const initialState = {
        income: {
            [currentYear]: {
                ...blankYearData(),
                'July': [
                    { id: 1, name: 'Monthly Salary', amount: 3800, type: 'Primary' },
                    { id: 2, name: 'Freelance Project', amount: 650, type: 'Side Hustle' },
                ]
            }
        },
        budgets: {
            [currentYear]: {
                ...blankYearData(),
                'August': [
                    { id: 1, name: 'Rent', category: 'Housing', amount: 1450, status: 'Paid' },
                    { id: 2, name: 'Council Tax', category: 'Housing', amount: 180, status: 'Paid' },
                    { id: 3, name: 'Groceries', category: 'Groceries', amount: 400, status: 'Ongoing' },
                ]
            }
        },
        subscriptions: [
            { id: 1, name: 'Netflix', amount: 13.99, billingCycle: 'Monthly', nextPayment: '2024-08-15' },
            { id: 2, name: 'Spotify', amount: 10.99, billingCycle: 'Monthly', nextPayment: '2024-08-11' },
        ],
        overtime: [
            { id: 1, date: '2024-07-20', time: '18:00 - 22:00', hourlyRate: 30, amount: 120, allocation: 'Vacation Fund', status: 'Completed' },
            { id: 2, date: '2024-07-28', time: '20:00 - 23:00', hourlyRate: 25, amount: 75, allocation: 'Vacation Fund', status: 'Not Started' },
        ],
        activePage: 'dashboard',
        currentYear: currentYear,
    };

    // --- LOCAL STORAGE FUNCTIONS ---
    function saveState() {
        localStorage.setItem('financeMgtState', JSON.stringify(state));
    }

    function loadState() {
        const savedState = localStorage.getItem('financeMgtState');
        if (!savedState) return null;

        const parsedState = JSON.parse(savedState);
        // --- Data Migration for old structure ---
        if (parsedState.monthlyIncome) {
            parsedState.income = { [new Date().getFullYear()]: parsedState.monthlyIncome };
            delete parsedState.monthlyIncome;
        }
        if (parsedState.monthlyBudgets) {
            parsedState.budgets = { [new Date().getFullYear()]: parsedState.monthlyBudgets };
            delete parsedState.monthlyBudgets;
        }
        if (!parsedState.currentYear) {
            parsedState.currentYear = new Date().getFullYear();
        }
        return parsedState;
    }

    let state = loadState() || initialState;

    // --- UTILITY FUNCTIONS ---
    const formatCurrency = (amount) => new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(amount);
    const getIcon = (name, classes = "w-5 h-5") => `<i data-lucide="${name}" class="${classes}"></i>`;
    const categoryIcons = {
        'Groceries': 'shopping-cart', 'Utilities': 'zap', 'Transport': 'car', 'Housing': 'home',
        'Entertainment': 'film', 'Health': 'heart', 'Subscriptions': 'repeat', 'Income': 'dollar-sign',
        'Personal Care': 'heart', 'Debt': 'credit-card', 'Savings': 'trending-up', 'Other': 'book-open',
    };
    const navItems = [
        { id: 'dashboard', label: 'Dashboard', icon: 'trending-up' },
        { id: 'income', label: 'Income', icon: 'dollar-sign' },
        { id: 'budget', label: 'Budgets', icon: 'shopping-cart' },
        { id: 'subscriptions', label: 'Subscriptions', icon: 'repeat' },
        { id: 'overtime', label: 'Overtime', icon: 'clock' },
        { id: 'calculator', label: 'Salary Calculator', icon: 'calculator' },
    ];
    const statusBadge = (status) => {
        const styles = {
            'Paid': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300',
            'Completed': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300',
            'Upcoming': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300',
            'Overdue': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300',
            'Ongoing': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300',
            'Not Started': 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300',
        };
        return `<span class="px-2.5 py-0.5 rounded-full text-xs font-medium ${styles[status] || ''}">${status}</span>`;
    };
    
    // --- DOM ELEMENTS ---
    const mainContent = document.getElementById('main-content');
    const modalContainer = document.getElementById('modal-container');
    const navMenu = document.getElementById('nav-menu');
    let expenseChart = null; // To hold the chart instance

    // --- MODAL MANAGEMENT ---
    function openModal(title, content) {
        modalContainer.innerHTML = `
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full transform transition-all">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200">${title}</h3>
                    <button data-action="close-modal" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">${getIcon('x')}</button>
                </div>
                ${content}
            </div>`;
        modalContainer.classList.remove('hidden');
        lucide.createIcons();
    }

    function closeModal() {
        modalContainer.classList.add('hidden');
        modalContainer.innerHTML = '';
    }

    // --- RENDER FUNCTIONS ---
    function renderNav() {
        navMenu.innerHTML = navItems.map(item => `
            <a href="#" data-page="${item.id}" class="nav-item flex items-center px-4 py-3 my-1 rounded-lg transition-colors duration-200 ${state.activePage === item.id ? 'bg-blue-500 text-white shadow-md' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700'}">
                ${getIcon(item.icon)}
                <span class="ml-4 font-medium">${item.label}</span>
            </a>
        `).join('');
    }

    function renderPage() {
        const pageRenderers = {
            'dashboard': renderDashboard,
            'income': renderIncomePage,
            'budget': renderBudgetPage,
            'subscriptions': renderSubscriptionsPage,
            'overtime': renderOvertimePage,
            'calculator': renderSalaryCalculatorPage,
        };
        if (pageRenderers[state.activePage]) {
            pageRenderers[state.activePage]();
        }
        lucide.createIcons();
        renderNav();
    }
    
    // --- DASHBOARD PAGE ---
    function renderDashboard() {
        const year = state.currentYear;
        const totalIncome = state.income[year] ? Object.values(state.income[year]).flat().reduce((sum, i) => sum + i.amount, 0) : 0;
        const overtimeIncome = state.overtime.reduce((sum, o) => sum + o.amount, 0);
        const grandTotalIncome = totalIncome + overtimeIncome;
        const totalBudgeted = state.budgets[year] ? Object.values(state.budgets[year]).flat().reduce((sum, b) => sum + b.amount, 0) : 0;
        const totalSubscriptionCost = state.subscriptions.reduce((sum, s) => sum + s.amount, 0);
        const totalExpenses = totalBudgeted + totalSubscriptionCost;
        const balance = grandTotalIncome - totalExpenses;

        mainContent.innerHTML = `
            <div class="space-y-6">
                <div class="flex items-center space-x-4">
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200">Dashboard</h2>
                    <span class="font-semibold text-gray-500 dark:text-gray-400">(${year})</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white p-6 rounded-xl shadow-lg">
                        <div class="flex justify-between items-start"><div><p class="text-sm font-medium opacity-80">Net Balance</p><p class="text-3xl font-bold">${formatCurrency(balance)}</p></div><div class="p-3 bg-white/20 rounded-lg">${getIcon('dollar-sign', 'w-6 h-6')}</div></div>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-emerald-600 text-white p-6 rounded-xl shadow-lg">
                        <div class="flex justify-between items-start"><div><p class="text-sm font-medium opacity-80">Total Income</p><p class="text-3xl font-bold">${formatCurrency(grandTotalIncome)}</p></div><div class="p-3 bg-white/20 rounded-lg">${getIcon('trending-up', 'w-6 h-6')}</div></div>
                    </div>
                    <div class="bg-gradient-to-br from-red-500 to-rose-600 text-white p-6 rounded-xl shadow-lg">
                        <div class="flex justify-between items-start"><div><p class="text-sm font-medium opacity-80">Total Expenses</p><p class="text-3xl font-bold">${formatCurrency(totalExpenses)}</p></div><div class="p-3 bg-white/20 rounded-lg">${getIcon('trending-down', 'w-6 h-6')}</div></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                        <h3 class="font-semibold text-lg text-gray-800 dark:text-gray-200 mb-4">Expense Composition</h3>
                        <canvas id="expenseChart"></canvas>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                            <h3 class="font-semibold text-lg text-gray-800 dark:text-gray-200 mb-4">Total Overtime Earned</h3>
                            <p class="text-3xl font-bold text-gray-800 dark:text-gray-200">${formatCurrency(overtimeIncome)}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">from ${state.overtime.length} shifts</p>
                            <button data-page="overtime" class="nav-item w-full flex items-center justify-center bg-blue-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-600 transition-colors">Manage Overtime ${getIcon('arrow-right', 'w-4 h-4 ml-2')}</button>
                        </div>
                    </div>
                </div>
            </div>`;
        
        if (expenseChart) expenseChart.destroy();
        const ctx = document.getElementById('expenseChart').getContext('2d');
        expenseChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Budget Items', 'Subscriptions'],
                datasets: [{
                    data: [totalBudgeted, totalSubscriptionCost],
                    backgroundColor: ['#4f46e5', '#818cf8'],
                    borderColor: document.documentElement.classList.contains('dark') ? '#1f2937' : '#fff',
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top', labels: { color: document.documentElement.classList.contains('dark') ? '#d1d5db' : '#374151' } },
                }
            }
        });
    }

    // --- GENERIC CRUD PAGE RENDERER ---
    function createCrudPage({ pageTitle, itemType, data, tableHeaders, rowRenderer, totalLabel, totalValue }) {
        mainContent.innerHTML = `
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200">${pageTitle}</h2>
                    <button data-action="add" data-type="${itemType.toLowerCase()}" class="flex items-center bg-blue-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-600 transition-colors">${getIcon('plus-circle', 'w-5 h-5 mr-2')} Add ${itemType}</button>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-md">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead><tr class="border-b border-gray-200 dark:border-gray-700">${tableHeaders.map(h => `<th class="p-3 text-sm font-semibold text-gray-500 dark:text-gray-400 ${h.align === 'right' ? 'text-right' : ''}">${h.label}</th>`).join('')}</tr></thead>
                            <tbody>${data.map(rowRenderer).join('')}</tbody>
                            <tfoot class="border-t-2 border-gray-200 dark:border-gray-700">
                                <tr>
                                    <td colspan="${tableHeaders.length - 2}" class="p-3 font-bold text-gray-800 dark:text-gray-200">${totalLabel}</td>
                                    <td class="p-3 text-right font-bold text-lg ${pageTitle.includes('Income') || pageTitle.includes('Overtime') ? 'text-green-500' : 'text-gray-800 dark:text-gray-200'}">${formatCurrency(totalValue)}</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>`;
    }
    
    // --- PAGE IMPLEMENTATIONS ---
    function renderIncomePage() {
        const year = state.currentYear;
        if (!state.income[year]) state.income[year] = blankYearData();

        const months = Object.keys(state.income[year]);
        const totalAnnualIncome = Object.values(state.income[year]).flat().reduce((sum, item) => sum + item.amount, 0);

        mainContent.innerHTML = `
            <div class="space-y-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div class="flex items-center gap-4">
                        <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200">Monthly Income</h2>
                        <div class="flex items-center gap-2">
                           <button data-action="prev-year" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">${getIcon('chevron-left')}</button>
                           <span class="text-2xl font-bold text-gray-700 dark:text-gray-300">${year}</span>
                           <button data-action="next-year" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">${getIcon('chevron-right')}</button>
                        </div>
                    </div>
                    <button data-action="add" data-type="income" class="flex-shrink-0 flex items-center bg-blue-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-600 transition-colors">${getIcon('plus-circle', 'w-5 h-5 mr-2')} Add Income</button>
                </div>
                <div class="space-y-3">
                    ${months.map(month => renderMonthAccordion(month, 'income')).join('')}
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md flex justify-between items-center">
                    <h3 class="font-bold text-lg text-gray-800 dark:text-gray-200">Total Annual Estimated Income</h3>
                    <p class="font-bold text-xl text-green-500">${formatCurrency(totalAnnualIncome)}</p>
                </div>
            </div>
        `;
    }
    
    function renderBudgetPage() {
        const year = state.currentYear;
        if (!state.budgets[year]) state.budgets[year] = blankYearData();

        const months = Object.keys(state.budgets[year]);
        const totalAnnualBudget = Object.values(state.budgets[year]).flat().reduce((sum, item) => sum + item.amount, 0);

        mainContent.innerHTML = `
            <div class="space-y-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                     <div class="flex items-center gap-4">
                        <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200">Monthly Budgets</h2>
                        <div class="flex items-center gap-2">
                           <button data-action="prev-year" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">${getIcon('chevron-left')}</button>
                           <span class="text-2xl font-bold text-gray-700 dark:text-gray-300">${year}</span>
                           <button data-action="next-year" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">${getIcon('chevron-right')}</button>
                        </div>
                    </div>
                    <button data-action="add" data-type="budget" class="flex-shrink-0 flex items-center bg-blue-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-600 transition-colors">${getIcon('plus-circle', 'w-5 h-5 mr-2')} Add Budget Item</button>
                </div>
                <div class="space-y-3">
                    ${months.map(month => renderMonthAccordion(month, 'budget')).join('')}
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md flex justify-between items-center">
                    <h3 class="font-bold text-lg text-gray-800 dark:text-gray-200">Total Annual Budget</h3>
                    <p class="font-bold text-xl text-red-500">${formatCurrency(totalAnnualBudget)}</p>
                </div>
            </div>
        `;
    }

    function renderMonthAccordion(month, type) {
        const year = state.currentYear;
        const data = type === 'income' ? state.income[year][month] : state.budgets[year][month];
        const monthlyTotal = data.reduce((sum, item) => sum + item.amount, 0);
        const isIncome = type === 'income';

        return `
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden">
                <button class="accordion-header w-full flex justify-between items-center p-4 text-left hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                    <span class="font-semibold text-lg text-gray-800 dark:text-gray-200">${month}</span>
                    <div class="flex items-center space-x-4">
                        <span class="font-semibold text-lg ${monthlyTotal > 0 ? (isIncome ? 'text-green-500' : 'text-red-500') : 'text-gray-500 dark:text-gray-400'}">${formatCurrency(monthlyTotal)}</span>
                        <i data-lucide="chevron-down" class="transition-transform duration-300"></i>
                    </div>
                </button>
                <div class="accordion-content">
                    <div class="border-t border-gray-200 dark:border-gray-700">
                        ${data.length > 0 ? (isIncome ? renderIncomeTable(data, month) : renderBudgetTable(data, month)) : `<p class="p-4 text-center text-gray-500 dark:text-gray-400">No items added for this month.</p>`}
                    </div>
                </div>
            </div>
        `;
    }

    function renderIncomeTable(data, month) {
        return `
            <table class="w-full text-left">
                <thead class="bg-gray-50 dark:bg-gray-700/50"><tr>
                    <th class="p-3 text-sm font-semibold text-gray-500 dark:text-gray-400">Source</th>
                    <th class="p-3 text-sm font-semibold text-gray-500 dark:text-gray-400">Type</th>
                    <th class="p-3 text-sm font-semibold text-gray-500 dark:text-gray-400 text-right">Amount</th>
                    <th class="p-3 text-sm font-semibold text-gray-500 dark:text-gray-400 text-right">Actions</th>
                </tr></thead>
                <tbody>${data.map(item => `
                    <tr class="border-b border-gray-200 dark:border-gray-700 last:border-0">
                        <td class="p-3 font-medium text-gray-800 dark:text-gray-200">${item.name}</td>
                        <td class="p-3"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">${item.type}</span></td>
                        <td class="p-3 text-right font-semibold text-green-500">${formatCurrency(item.amount)}</td>
                        <td class="p-3 text-right"><div class="flex justify-end items-center space-x-2">
                            <button data-action="edit" data-type="income" data-month="${month}" data-id="${item.id}" class="p-2 text-gray-500 hover:text-blue-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">${getIcon('pencil', 'w-4 h-4')}</button>
                            <button data-action="delete" data-type="income" data-month="${month}" data-id="${item.id}" class="p-2 text-gray-500 hover:text-red-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">${getIcon('trash-2', 'w-4 h-4')}</button>
                        </div></td>
                    </tr>`).join('')}
                </tbody>
            </table>`;
    }

    function renderBudgetTable(data, month) {
        return `
            <table class="w-full text-left">
                <thead class="bg-gray-50 dark:bg-gray-700/50"><tr>
                    <th class="p-3 text-sm font-semibold text-gray-500 dark:text-gray-400">Item</th>
                    <th class="p-3 text-sm font-semibold text-gray-500 dark:text-gray-400">Category</th>
                    <th class="p-3 text-sm font-semibold text-gray-500 dark:text-gray-400">Status</th>
                    <th class="p-3 text-sm font-semibold text-gray-500 dark:text-gray-400 text-right">Amount</th>
                    <th class="p-3 text-sm font-semibold text-gray-500 dark:text-gray-400 text-right">Actions</th>
                </tr></thead>
                <tbody>${data.map(item => `
                    <tr class="border-b border-gray-200 dark:border-gray-700 last:border-0">
                        <td class="p-3 font-medium text-gray-800 dark:text-gray-200">${item.name}</td>
                        <td class="p-3 text-gray-600 dark:text-gray-300"><span class="inline-flex items-center text-xs font-medium">${getIcon(categoryIcons[item.category] || 'book-open', 'w-4 h-4 mr-2')} ${item.category}</span></td>
                        <td class="p-3">${statusBadge(item.status)}</td>
                        <td class="p-3 text-right font-semibold text-red-500">${formatCurrency(item.amount)}</td>
                        <td class="p-3 text-right"><div class="flex justify-end items-center space-x-2">
                            <button data-action="edit" data-type="budget" data-month="${month}" data-id="${item.id}" class="p-2 text-gray-500 hover:text-blue-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">${getIcon('pencil', 'w-4 h-4')}</button>
                            <button data-action="delete" data-type="budget" data-month="${month}" data-id="${item.id}" class="p-2 text-gray-500 hover:text-red-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">${getIcon('trash-2', 'w-4 h-4')}</button>
                        </div></td>
                    </tr>`).join('')}
                </tbody>
            </table>`;
    }
    
    function renderSubscriptionsPage() {
        createCrudPage({
            pageTitle: 'Subscriptions', itemType: 'Subscription', data: state.subscriptions,
            tableHeaders: [
                { label: 'Name' }, { label: 'Billing Cycle' }, { label: 'Next Payment' }, { label: 'Amount', align: 'right' }, { label: 'Actions', align: 'right' }
            ],
            rowRenderer: sub => `
                <tr class="border-b border-gray-200 dark:border-gray-700 last:border-0">
                    <td class="p-3 font-medium text-gray-800 dark:text-gray-200">${sub.name}</td>
                    <td class="p-3 text-sm text-gray-600 dark:text-gray-300">${sub.billingCycle}</td>
                    <td class="p-3 text-sm text-gray-600 dark:text-gray-300">${sub.nextPayment}</td>
                    <td class="p-3 text-right font-semibold text-gray-700 dark:text-gray-200">${formatCurrency(sub.amount)}</td>
                    <td class="p-3 text-right"><div class="flex justify-end items-center space-x-2">
                        <button data-action="edit" data-id="${sub.id}" data-type="subscriptions" class="p-2 text-gray-500 hover:text-blue-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">${getIcon('pencil', 'w-4 h-4')}</button>
                        <button data-action="delete" data-id="${sub.id}" data-type="subscriptions" class="p-2 text-gray-500 hover:text-red-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">${getIcon('trash-2', 'w-4 h-4')}</button>
                    </div></td>
                </tr>`,
            totalLabel: 'Total Monthly Cost', totalValue: state.subscriptions.reduce((sum, i) => sum + i.amount, 0)
        });
    }

    function renderOvertimePage() {
        createCrudPage({
            pageTitle: 'Overtime Log', itemType: 'Overtime', data: state.overtime,
            tableHeaders: [
                { label: 'Date' }, { label: 'Time' }, { label: 'Rate/hr', align: 'right' }, { label: 'Allocation' }, { label: 'Status' }, { label: 'Amount', align: 'right' }, { label: 'Actions', align: 'right' }
            ],
            rowRenderer: item => `
                <tr class="border-b border-gray-200 dark:border-gray-700 last:border-0">
                    <td class="p-3 font-medium text-gray-800 dark:text-gray-200">${item.date}</td>
                    <td class="p-3 text-sm text-gray-600 dark:text-gray-300">${item.time}</td>
                    <td class="p-3 text-right text-sm text-gray-600 dark:text-gray-300">${formatCurrency(item.hourlyRate)}</td>
                    <td class="p-3 text-sm text-gray-600 dark:text-gray-300">${item.allocation}</td>
                    <td class="p-3">${statusBadge(item.status)}</td>
                    <td class="p-3 text-right font-semibold text-green-500">${formatCurrency(item.amount)}</td>
                    <td class="p-3 text-right"><div class="flex justify-end items-center space-x-2">
                        <button data-action="edit" data-id="${item.id}" data-type="overtime" class="p-2 text-gray-500 hover:text-blue-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">${getIcon('pencil', 'w-4 h-4')}</button>
                        <button data-action="delete" data-id="${item.id}" data-type="overtime" class="p-2 text-gray-500 hover:text-red-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">${getIcon('trash-2', 'w-4 h-4')}</button>
                    </div></td>
                </tr>`,
            totalLabel: 'Total Overtime Earned', totalValue: state.overtime.reduce((sum, i) => sum + i.amount, 0)
        });
    }

    // --- SALARY CALCULATOR PAGE ---
    function renderSalaryCalculatorPage() {
        mainContent.innerHTML = `
            <div class="space-y-6">
                <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200">Salary Calculator (UK)</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md space-y-6">
                        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200">Enter Your Details</h3>
                        <form id="salary-calculator-form" class="space-y-4">
                            <div>
                                <label for="gross-salary" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Gross Salary (Â£)</label>
                                <div class="flex mt-1">
                                    <input type="number" name="gross-salary" id="gross-salary" class="flex-grow block w-full rounded-l-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-gray-900 dark:text-gray-200 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm" placeholder="e.g., 35000">
                                    <select id="salary-period" name="salary-period" class="block rounded-r-md border-l-0 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700/50 px-3 py-2 text-gray-900 dark:text-gray-200 focus:ring-2 focus:ring-inset focus:ring-blue-500">
                                        <option>Annually</option>
                                        <option>Monthly</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label for="tax-code" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tax Code</label>
                                <input type="text" name="tax-code" id="tax-code" value="1257L" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-gray-900 dark:text-gray-200 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm">
                            </div>
                            <button type="submit" class="w-full bg-blue-500 text-white px-6 py-3 rounded-lg shadow-md hover:bg-blue-600 transition-colors flex items-center justify-center">${getIcon('calculator', 'w-5 h-5 mr-2')} Calculate</button>
                        </form>
                    </div>
                    <div id="salary-results" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md space-y-6 hidden">
                        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200">Results Breakdown</h3>
                        <div id="take-home-summary"></div>
                        <div id="annual-breakdown"></div>
                        <div id="monthly-breakdown"></div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function calculateSalary(salary, period, taxCode) {
        // Step 1: Standardize salary to annual
        const grossAnnual = period === 'Monthly' ? salary * 12 : salary;

        // Step 2: Calculate Personal Allowance from Tax Code
        let personalAllowance = 12570; // Default
        const taxCodeMatch = taxCode.match(/^(\d+)/);
        if (taxCodeMatch) {
            personalAllowance = parseInt(taxCodeMatch[1], 10) * 10;
        }
        
        // Taper personal allowance for high earners
        const PERSONAL_ALLOWANCE_LIMIT = 100000;
        if (grossAnnual > PERSONAL_ALLOWANCE_LIMIT) {
            personalAllowance -= Math.floor((grossAnnual - PERSONAL_ALLOWANCE_LIMIT) / 2);
            if (personalAllowance < 0) personalAllowance = 0;
        }

        const taxableIncome = Math.max(0, grossAnnual - personalAllowance);
        let tax = 0;

        // Step 3: Income Tax Calculation (England/NI rates 2024/25)
        const BASIC_RATE_LIMIT = 37700;
        const HIGHER_RATE_LIMIT = 125140;

        if (taxableIncome > 0) {
            if (taxableIncome <= BASIC_RATE_LIMIT) {
                tax = taxableIncome * 0.20;
            } else if (taxableIncome <= HIGHER_RATE_LIMIT) {
                tax = (BASIC_RATE_LIMIT * 0.20) + ((taxableIncome - BASIC_RATE_LIMIT) * 0.40);
            } else {
                tax = (BASIC_RATE_LIMIT * 0.20) + ((HIGHER_RATE_LIMIT - BASIC_RATE_LIMIT) * 0.40) + ((taxableIncome - HIGHER_RATE_LIMIT) * 0.45);
            }
        }

        // Step 4: National Insurance Calculation (Class 1 rates 2024/25)
        const NI_LOWER_THRESHOLD = 12570;
        const NI_UPPER_THRESHOLD = 50270;
        let nationalInsurance = 0;

        if (grossAnnual > NI_LOWER_THRESHOLD) {
            const earningsInMainBand = Math.min(grossAnnual, NI_UPPER_THRESHOLD) - NI_LOWER_THRESHOLD;
            if (earningsInMainBand > 0) {
                nationalInsurance += earningsInMainBand * 0.08;
            }
            if (grossAnnual > NI_UPPER_THRESHOLD) {
                const earningsInUpperBand = grossAnnual - NI_UPPER_THRESHOLD;
                nationalInsurance += earningsInUpperBand * 0.02;
            }
        }
        
        const takeHomePay = grossAnnual - tax - nationalInsurance;

        return {
            grossAnnual,
            personalAllowance,
            taxableAnnual: taxableIncome,
            taxAnnual: tax,
            niAnnual: nationalInsurance,
            netAnnual: takeHomePay,
        };
    }

    function displaySalaryResults(results) {
        const resultsContainer = document.getElementById('salary-results');
        const summaryContainer = document.getElementById('take-home-summary');
        const annualContainer = document.getElementById('annual-breakdown');
        const monthlyContainer = document.getElementById('monthly-breakdown');

        summaryContainer.innerHTML = `
            <div class="space-y-4">
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Annual Take-Home Pay</p>
                    <p class="text-3xl font-bold text-green-500">${formatCurrency(results.netAnnual)}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Monthly Take-Home Pay</p>
                    <p class="text-3xl font-bold text-green-500">${formatCurrency(results.netAnnual / 12)}</p>
                </div>
            </div>
        `;

        annualContainer.innerHTML = `
            <div>
                <h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-2">Annual Breakdown</h4>
                <dl class="space-y-2 text-sm">
                    ${resultRow('Gross Pay', results.grossAnnual)}
                    ${resultRow('Personal Allowance', results.personalAllowance)}
                    ${resultRow('Taxable Income', results.taxableAnnual)}
                    ${resultRow('Income Tax', -results.taxAnnual, 'text-red-500')}
                    ${resultRow('National Insurance', -results.niAnnual, 'text-red-500')}
                    ${resultRow('Take Home', results.netAnnual, 'text-green-500', true)}
                </dl>
            </div>
        `;

        monthlyContainer.innerHTML = `
            <div>
                <h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-2">Monthly Breakdown</h4>
                <dl class="space-y-2 text-sm">
                    ${resultRow('Gross Pay', results.grossAnnual / 12)}
                    ${resultRow('Income Tax', -(results.taxAnnual / 12), 'text-red-500')}
                    ${resultRow('National Insurance', -(results.niAnnual / 12), 'text-red-500')}
                    ${resultRow('Take Home', results.netAnnual / 12, 'text-green-500', true)}
                </dl>
            </div>
        `;
        
        resultsContainer.classList.remove('hidden');
    }

    function resultRow(label, value, colorClass = 'text-gray-700 dark:text-gray-300', isBold = false) {
        return `
            <div class="flex justify-between items-center border-t border-gray-200 dark:border-gray-700/50 pt-2">
                <dt class="text-gray-600 dark:text-gray-400">${label}</dt>
                <dd class="${colorClass} ${isBold ? 'font-bold' : 'font-medium'}">${formatCurrency(value)}</dd>
            </div>
        `;
    }


    // --- EVENT LISTENERS ---
    
    // Theme Toggling
    function handleThemeToggle() {
        document.documentElement.classList.toggle('dark');
        if (state.activePage === 'dashboard') renderDashboard(); // Re-render chart with new theme colors
    }
    document.getElementById('theme-toggle').addEventListener('click', handleThemeToggle);
    document.getElementById('landing-theme-toggle').addEventListener('click', handleThemeToggle);

    // Sidebar Toggle
    document.getElementById('open-sidebar-btn').addEventListener('click', () => document.getElementById('sidebar').classList.remove('-translate-x-full'));
    document.getElementById('close-sidebar-btn').addEventListener('click', () => document.getElementById('sidebar').classList.add('-translate-x-full'));

    // App Entry / Exit
    document.getElementById('enter-dashboard-btn').addEventListener('click', () => {
        document.getElementById('landing-page').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
        document.getElementById('app-container').classList.add('flex');
        saveState(); // Save initial state on first entry if it doesn't exist
        renderPage();
    });
    document.getElementById('logout-btn').addEventListener('click', (e) => {
        e.preventDefault();
        localStorage.removeItem('financeMgtState');
        window.location.reload();
    });
    
    // --- UNIFIED CLICK HANDLER FOR THE ENTIRE DOCUMENT ---
    document.body.addEventListener('click', e => {
        const target = e.target;
        
        // Page Navigation
        const navItem = target.closest('.nav-item');
        if (navItem && navItem.dataset.page) {
            e.preventDefault();
            state.activePage = navItem.dataset.page;
            saveState();
            renderPage();
            if (window.innerWidth < 1024) {
                document.getElementById('sidebar').classList.add('-translate-x-full');
            }
            return;
        }
        
        // Accordion Toggle
        const accordionHeader = target.closest('.accordion-header');
        if (accordionHeader) {
            const content = accordionHeader.nextElementSibling;
            const icon = accordionHeader.querySelector('[data-lucide="chevron-down"]');
            if (content.style.maxHeight && content.style.maxHeight !== '0px') {
                content.style.maxHeight = null;
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
                icon.style.transform = 'rotate(180deg)';
            }
            return;
        }

        const actionButton = target.closest('button[data-action]');
        if (!actionButton) return;

        // Handle actions within the main content (opening modals, changing year)
        if (mainContent.contains(actionButton)) {
            const action = actionButton.dataset.action;

            if (action === 'prev-year') {
                state.currentYear--;
                renderPage();
                return;
            }
            if (action === 'next-year') {
                state.currentYear++;
                renderPage();
                return;
            }

            const id = actionButton.dataset.id ? parseInt(actionButton.dataset.id, 10) : null;
            const type = actionButton.dataset.type || state.activePage;
            
            const pageConfig = {
                income: { title: 'Income Source', form: getMonthlyIncomeForm },
                budget: { title: 'Budget Item', form: getBudgetForm },
                subscriptions: { title: 'Subscription', form: getSubscriptionForm },
                overtime: { title: 'Overtime Entry', form: getOvertimeForm },
            }[type];

            if (!pageConfig) return;

            if (action === 'add') {
                openModal(`Add New ${pageConfig.title}`, pageConfig.form());
            } else if (action === 'edit') {
                const month = actionButton.dataset.month;
                const item = type === 'income' ? state.income[state.currentYear][month].find(i => i.id === id) :
                             type === 'budget' ? state.budgets[state.currentYear][month].find(i => i.id === id) :
                             state[type].find(i => i.id === id);
                openModal(`Edit ${pageConfig.title}`, pageConfig.form(item, month));
            } else if (action === 'delete') {
                const month = actionButton.dataset.month;
                const item = type === 'income' ? state.income[state.currentYear][month].find(i => i.id === id) :
                             type === 'budget' ? state.budgets[state.currentYear][month].find(i => i.id === id) :
                             state[type].find(i => i.id === id);
                openModal(`Confirm Deletion`, `
                    <div class="p-6"><p class="text-gray-700 dark:text-gray-300">Are you sure you want to delete "${item.name || item.allocation}"?</p></div>
                    <div class="p-4 bg-gray-50 dark:bg-gray-800/50 border-t flex justify-end space-x-2">
                        <button data-action="close-modal" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg">Cancel</button>
                        <button data-action="confirm-delete" data-type="${type}" data-month="${month || ''}" data-id="${id}" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Delete</button>
                    </div>`);
            }
            return;
        }

        // Handle actions within the modal (closing, confirming)
        if (modalContainer.contains(actionButton)) {
            const action = actionButton.dataset.action;
            if (action === 'close-modal') {
                closeModal();
            } else if (action === 'confirm-delete') {
                const id = parseInt(actionButton.dataset.id, 10);
                const type = actionButton.dataset.type;
                const month = actionButton.dataset.month;
                
                if (type === 'income') {
                    state.income[state.currentYear][month] = state.income[state.currentYear][month].filter(item => item.id !== id);
                } else if (type === 'budget') {
                    state.budgets[state.currentYear][month] = state.budgets[state.currentYear][month].filter(item => item.id !== id);
                } else {
                    state[type] = state[type].filter(item => item.id !== id);
                }
                
                saveState();
                closeModal();
                renderPage();
            }
        }
    });

    mainContent.addEventListener('submit', e => {
        if (e.target.id === 'salary-calculator-form') {
            e.preventDefault();
            const salaryInput = document.getElementById('gross-salary');
            const periodInput = document.getElementById('salary-period');
            const taxCodeInput = document.getElementById('tax-code');

            const grossSalary = parseFloat(salaryInput.value);
            const period = periodInput.value;
            const taxCode = taxCodeInput.value;

            if (!isNaN(grossSalary) && grossSalary > 0) {
                const results = calculateSalary(grossSalary, period, taxCode);
                displaySalaryResults(results);
            } else {
                 document.getElementById('salary-results').classList.add('hidden');
            }
        }
    });

    modalContainer.addEventListener('submit', e => {
        e.preventDefault();
        const form = e.target;
        const id = form.dataset.id ? parseInt(form.dataset.id, 10) : null;
        const type = form.dataset.type;
        
        const formData = new FormData(form);
        const newItem = { id: id || Date.now() };
        for (let [key, value] of formData.entries()) {
            newItem[key] = isNaN(value) || ['time', 'date', 'month'].includes(key) || value === '' ? value : parseFloat(value);
        }
        
        if (type === 'overtime') {
            const duration = calculateDuration(newItem.time);
            newItem.amount = duration * (newItem.hourlyRate || 0);
        }

        if (type === 'income' || type === 'budget') {
            const month = newItem.month;
            const stateKey = type === 'income' ? 'income' : 'budgets';
            delete newItem.month;
            if (id) {
                const originalMonth = form.dataset.originalMonth;
                if (originalMonth !== month) {
                    state[stateKey][state.currentYear][originalMonth] = state[stateKey][state.currentYear][originalMonth].filter(i => i.id !== id);
                    state[stateKey][state.currentYear][month].push(newItem);
                } else {
                    state[stateKey][state.currentYear][month] = state[stateKey][state.currentYear][month].map(item => item.id === id ? newItem : item);
                }
            } else {
                state[stateKey][state.currentYear][month].push(newItem);
            }
        } else {
             if (id) {
                state[type] = state[type].map(item => item.id === id ? newItem : item);
            } else {
                state[type].push(newItem);
            }
        }
        
        saveState();
        closeModal();
        renderPage();
    });
    
    modalContainer.addEventListener('input', e => {
        const form = e.target.closest('#overtime-form');
        if (!form) return;
        
        const timeInput = form.querySelector('#overtime-time');
        const rateInput = form.querySelector('#overtime-rate');
        const amountInput = form.querySelector('#overtime-amount');

        const duration = calculateDuration(timeInput.value);
        const rate = parseFloat(rateInput.value) || 0;
        
        amountInput.value = (duration * rate).toFixed(2);
    });

    // --- FORM RENDERERS ---
    const formInputClasses = "mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md dark:text-gray-200";
    
    function getMonthlyIncomeForm(item = {}, month = '') {
        const months = Object.keys(state.income[state.currentYear]);
        const currentMonth = new Date().toLocaleString('default', { month: 'long' });
        return `
            <form data-id="${item.id || ''}" data-type="income" data-original-month="${month}">
                <div class="p-6 space-y-4">
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Month</label>
                        <select name="month" class="${formInputClasses}">${months.map(m => `<option ${ (month || currentMonth) === m ? 'selected' : ''}>${m}</option>`).join('')}</select>
                    </div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Source Name</label><input type="text" name="name" value="${item.name || ''}" class="${formInputClasses}" required></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Amount (Â£)</label><input type="number" step="0.01" name="amount" value="${item.amount || ''}" class="${formInputClasses}" required></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Type</label><select name="type" class="${formInputClasses}"><option ${item.type === 'Primary' ? 'selected' : ''}>Primary</option><option ${item.type === 'Side Hustle' ? 'selected' : ''}>Side Hustle</option><option ${item.type === 'Other' ? 'selected' : ''}>Other</option></select></div>
                </div>
                <div class="p-4 bg-gray-50 dark:bg-gray-800/50 border-t flex justify-end"><button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Save</button></div>
            </form>`;
    }
    
    function getBudgetForm(item = {}, month = '') {
        const months = Object.keys(state.budgets[state.currentYear]);
        const currentMonth = new Date().toLocaleString('default', { month: 'long' });
        const categories = Object.keys(categoryIcons).filter(c => c !== 'Income');
        return `
            <form data-id="${item.id || ''}" data-type="budget" data-original-month="${month}">
                <div class="p-6 space-y-4">
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Month</label>
                        <select name="month" class="${formInputClasses}">${months.map(m => `<option ${ (month || currentMonth) === m ? 'selected' : ''}>${m}</option>`).join('')}</select>
                    </div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Item Name</label><input type="text" name="name" value="${item.name || ''}" class="${formInputClasses}" required></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Amount (Â£)</label><input type="number" step="0.01" name="amount" value="${item.amount || ''}" class="${formInputClasses}" required></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Category</label><select name="category" class="${formInputClasses}">${categories.map(c => `<option ${item.category === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Status</label><select name="status" class="${formInputClasses}"><option ${item.status === 'Upcoming' ? 'selected' : ''}>Upcoming</option><option ${item.status === 'Paid' ? 'selected' : ''}>Paid</option><option ${item.status === 'Overdue' ? 'selected' : ''}>Overdue</option><option ${item.status === 'Ongoing' ? 'selected' : ''}>Ongoing</option></select></div>
                </div>
                <div class="p-4 bg-gray-50 dark:bg-gray-800/50 border-t flex justify-end"><button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Save</button></div>
            </form>`;
    }
    
    function getSubscriptionForm(item = {}) {
        return `
            <form data-id="${item.id || ''}" data-type="subscriptions">
                <div class="p-6 space-y-4">
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Name</label><input type="text" name="name" value="${item.name || ''}" class="${formInputClasses}" required></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Amount (Â£)</label><input type="number" step="0.01" name="amount" value="${item.amount || ''}" class="${formInputClasses}" required></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Billing Cycle</label><select name="billingCycle" class="${formInputClasses}"><option ${item.billingCycle === 'Monthly' ? 'selected' : ''}>Monthly</option><option ${item.billingCycle === 'Annually' ? 'selected' : ''}>Annually</option></select></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Next Payment</label><input type="date" name="nextPayment" value="${item.nextPayment || ''}" class="${formInputClasses}"></div>
                </div>
                <div class="p-4 bg-gray-50 dark:bg-gray-800/50 border-t flex justify-end"><button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Save</button></div>
            </form>`;
    }
    
    function calculateDuration(timeString) {
        if (!timeString || !timeString.includes(' - ')) return 0;
        const parts = timeString.split(' - ');
        const startTime = parts[0].split(':');
        const endTime = parts[1].split(':');

        if (startTime.length !== 2 || endTime.length !== 2) return 0;

        const startHour = parseInt(startTime[0], 10);
        const startMinute = parseInt(startTime[1], 10);
        const endHour = parseInt(endTime[0], 10);
        const endMinute = parseInt(endTime[1], 10);

        if (isNaN(startHour) || isNaN(startMinute) || isNaN(endHour) || isNaN(endMinute)) return 0;

        const startTotalHours = startHour + startMinute / 60;
        const endTotalHours = endHour + endMinute / 60;

        return endTotalHours > startTotalHours ? endTotalHours - startTotalHours : 0;
    }

    function getOvertimeForm(item = {}) {
        return `
            <form id="overtime-form" data-id="${item.id || ''}" data-type="overtime">
                <div class="p-6 space-y-4">
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Date</label><input type="date" name="date" value="${item.date || ''}" class="${formInputClasses}" required></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Time</label><input type="text" id="overtime-time" name="time" value="${item.time || ''}" placeholder="e.g., 18:00 - 22:00" class="${formInputClasses}" required></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Hourly Rate (Â£)</label><input type="number" step="0.01" id="overtime-rate" name="hourlyRate" value="${item.hourlyRate || ''}" class="${formInputClasses}" required></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Amount (Â£)</label><input type="number" step="0.01" id="overtime-amount" name="amount" value="${item.amount || '0.00'}" class="${formInputClasses} bg-gray-100 dark:bg-gray-800" readonly></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Allocation</label><input type="text" name="allocation" value="${item.allocation || ''}" class="${formInputClasses}" required></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Status</label><select name="status" class="${formInputClasses}"><option ${item.status === 'Not Started' ? 'selected' : ''}>Not Started</option><option ${item.status === 'Completed' ? 'selected' : ''}>Completed</option></select></div>
                </div>
                <div class="p-4 bg-gray-50 dark:bg-gray-800/50 border-t flex justify-end"><button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Save</button></div>
            </form>`;
    }

    // --- INITIAL APP LOAD ---
    function init() {
        if (loadState()) {
            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('app-container').classList.add('flex');
            renderPage();
        } else {
            document.getElementById('landing-page').classList.remove('hidden');
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('flex');
            lucide.createIcons();
        }
    }

    init();
});
</script>

</body>
</html>
